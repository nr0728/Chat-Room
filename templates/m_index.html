<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 8% auto;
            padding: 30px 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content input,
        .modal-content button,
        .modal-content img {
            margin: 8px 0;
            display: block;
        }

        .modal-content input {
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }

        .modal-content img {
            cursor: pointer;
            margin: 8px auto;
            display: block;
        }

        .modal-content button {
            width: 100%;
            margin: 8px 0;
            padding: 10px 0;
            border-radius: 4px;
            border: none;
            background: #8CC269;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }

        #language-selector {
            background-color: #8CC269;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            padding: 10px 2.5px;
            text-decoration: none;
            font-size: 16px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            width: 25%;
        }
    </style>
    </script>
    <style>
        .emoji-button {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            width: unset;
        }

        .emoji-button:hover {
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='m_styles.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='prism.css') }}">
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <link href="{{ url_for('static', filename='sweetalert2.all.min.js') }}" rel="stylesheet">
    </link>
</head>

<body>
    <input type="text" style="display:none">
    <h1>èŠå¤©å®¤</h1>
    <div id="nav-buttons">
        <button onclick="showRegisterForm()" id="register-button">æ³¨å†Œ</button>
        <button onclick="showLoginForm()" id="login-button">ç™»å½•</button>
        <button onclick="window.location.href='/panel'" id="panel-button" style="display:none;">æ§åˆ¶é¢æ¿</button>
    </div>
    <div id="chat-container">
        <div id="chat-history" style="width: 90%;">
        </div>
        <div id="input-container">
            <div style="display: flex; align-items: center; gap: 10px; flex-direction: column; align-items: stretch;">
                <input type="text" id="message-input" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯â€¦"
                    style="height:90px; margin: 0 auto; display: block;width: 80%; font-size: 20px;" autocomplete="off"
                    readonly onfocus="this.removeAttribute('readonly');">
                <div style="display: flex; align-items: center; gap: 10px;margin: 0 auto;">
                    <button onclick="startVoiceInput()" style="height:60px;padding:10px;width: unset;font-size: 2vw;">ğŸ¤
                        è¯­éŸ³è¾“å…¥</button>
                    <select id="language-selector"
                        style="width: unset;height:60px;background-color: #8CC269;font-size: 2vw;">
                        <option value="zh-CN">ä¸­æ–‡</option>
                        <option value="en-US">English</option>
                        <option value="es-ES">EspaÃ±ol</option>
                        <option value="fr-FR">FranÃ§ais</option>
                        <option value="de-DE">Deutsch</option>
                        <option value="ja-JP">æ—¥æœ¬èª</option>
                        <option value="ko-KR">í•œêµ­ì–´</option>
                        <option value="it-IT">Italiano</option>
                        <option value="pt-BR">PortuguÃªs</option>
                        <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                    </select>
                    <button onclick="openEmojiPicker()" style="height:60px;padding:10px;width: unset;font-size: 2vw;">ğŸ˜€
                        æ’å…¥ Emoji
                        è¡¨æƒ…åŒ…</button>
                    <button onclick="sendMessage()" style="height:60px;width: unset;font-size: 2vw;">ğŸ“©
                        å‘é€æ¶ˆæ¯</button>
                </div>
            </div>
        </div>
        <div id="input-container-code" style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
            <textarea type="text" id="message-input-code" class="swal-content__textarea" placeholder=" è¾“å…¥ä½ çš„ä»£ç â€¦" rows="2"
                autocomplete="off" style="flex:1;width: 80%;"></textarea>
            <div style="display: flex; align-items: center; gap: 10px;margin: 0 auto;">
                <button onclick="sendCode()" style="height: 60px;width: 100%;">ğŸ“© å‘é€ä»£ç </button>
            </div>
        </div>
        <!-- ç§èŠå…¥å£æŒ‰é’® -->
        <button onclick="openPrivateChatPanel()" style="height:60px;width: 100%;margin-top:10px;">ğŸ’¬ ç§èŠ/å†å²</button>
    </div>

    <div id="register-form" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegisterForm()"
                style="align-self: flex-end; cursor:pointer;">&times;</span>
            <h2>æ³¨å†Œ</h2>
            <input type="text" id="register-username" placeholder="ç”¨æˆ·å" style="width: 100%;" class="swal2-input">
            <input type="password" id="register-password" placeholder="å¯†ç " style="width: 100%;" class="swal2-input">
            <input type="password" id="register-confirm-password" placeholder="ç¡®è®¤å¯†ç " style="width: 100%;"
                class="swal2-input">
            <input type="text" id="register-captcha" placeholder="éªŒè¯ç " style="width: 100%;" class="swal2-input">
            <img id="captcha-image-reg" src="#" alt="éªŒè¯ç " onclick="reloadCode(2);">
            <p>æ³¨ï¼šè¯·åœ¨æ³¨å†Œåç™»å½•ã€‚</p>
            <button onclick="register()" style="width: 100%;">æ³¨å†Œ</button>
        </div>
    </div>

    <div id="login-form" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginForm()" style="align-self: flex-end; cursor:pointer;">&times;</span>
            <h2>ç™»å½•</h2>
            <input type="text" id="login-username" placeholder="ç”¨æˆ·å" style="width: 100%;" class="swal2-input">
            <input type="password" id="login-password" placeholder="å¯†ç " style="width: 100%;" class="swal2-input">
            <input type="text" id="login-captcha" placeholder="éªŒè¯ç " style="width: 100%;" class="swal2-input">
            <img id="captcha-image-log" src="#" alt="éªŒè¯ç " onclick="reloadCode(1);">
            <br />
            <button onclick="login()" style="width: 100%;">ç™»å½•</button>
            <br />
            <button onclick="loginWithLoginkey()" style="width: 100%;">ä½¿ç”¨ Loginkey ç™»å½•</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>


    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
        fetch('user_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: ``
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'OK' && data.message.includes('ç®¡ç†å‘˜')) {
                    document.getElementById('panel-button').style.display = 'inline-block';
                }
            });

        let usingUsername = 'æœªç™»å½•ï¼Œè¯·å…ˆç™»å½• ã€‚'
        const socket = io();

        socket.on('new_message', (data) => {
            updateChatHistory();
        });

        fetch('user_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: ``
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'OK') {
                    document.getElementById('register-button').innerText = "æ‚¨å·²ç™»å½•";
                    document.getElementById('login-button').innerText = "ç™»å‡º";
                    showNotification('æ‚¨æ­£ä»¥ ' + data.message + ' çš„èº«ä»½èŠå¤©ã€‚', 'ok');
                    usingUsername = data.message;
                    updateChatHistory();
                } else {
                    showNotification('ç³»ç»Ÿæ¶ˆæ¯ï¼šç™»å½•åæ‰å¯å‘é€æ¶ˆæ¯ã€‚', 'fail');
                }
            });
        function reloadCode(CodingOIer) {
            if (CodingOIer == 2) document.getElementById('captcha-image-reg').src = "/captcha?" + String(Math.random(1, 1145141919810));
            else document.getElementById('captcha-image-log').src = "/captcha?" + String(Math.random(1, 1145141919810));
        }
        function showUserInformation(uname) {
            fetch('/user_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        Swal.fire({
                            imageUrl: "https://cdn.luogu.com.cn/images/icon.png",
                            title: uname,
                            imageHeight: 96,
                            showCancelButton: true,
                            confirmButtonText: data.is_2fa_enabled ? 'å…³é—­ 2FA' : 'å¯ç”¨ 2FA',
                            cancelButtonText: 'å…³é—­',
                            footer: '<button onclick="openLoginkeyRegistration()" style="width:unset;">æ³¨å†Œ Loginkey</button>'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                if (data.is_2fa_enabled) {
                                    // éªŒè¯ 2FA åå…³é—­
                                    Swal.fire({
                                        title: 'éªŒè¯ 2FA',
                                        input: 'text',
                                        inputLabel: 'è¯·è¾“å…¥æ‚¨çš„ 2FA éªŒè¯ç ',
                                        inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                                        showCancelButton: true,
                                        confirmButtonText: 'éªŒè¯å¹¶å…³é—­ 2FA',
                                        cancelButtonText: 'å–æ¶ˆ',
                                    }).then((verifyResult) => {
                                        if (verifyResult.isConfirmed) {
                                            const code = verifyResult.value.trim();
                                            if (!code) {
                                                Swal.fire({
                                                    title: 'é”™è¯¯',
                                                    text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                                                    icon: 'error',
                                                });
                                                return;
                                            }

                                            fetch('/disable_2fa', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/x-www-form-urlencoded',
                                                },
                                                body: `code=${encodeURIComponent(code)}`,
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.status === 'OK') {
                                                        Swal.fire({
                                                            title: '2FA å·²ç¦ç”¨',
                                                            text: 'æ‚¨å·²æˆåŠŸå…³é—­ 2FA',
                                                            icon: 'success',
                                                        });
                                                    } else {
                                                        Swal.fire({
                                                            title: 'é”™è¯¯',
                                                            text: data.message,
                                                            icon: 'error',
                                                        });
                                                    }
                                                })
                                                .catch(error => {
                                                    Swal.fire({
                                                        title: 'é”™è¯¯',
                                                        text: 'ç¦ç”¨ 2FA æ—¶å‡ºç°é—®é¢˜',
                                                        icon: 'error',
                                                    });
                                                });
                                        }
                                    });
                                } else {
                                    fetch('/enable_2fa', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                        },
                                    })
                                        .then(response => {
                                            if (response.ok) {
                                                return response.json(); // è¿”å› JSON æ•°æ®ï¼ŒåŒ…æ‹¬äºŒç»´ç å’Œå¯†é’¥
                                            } else {
                                                throw new Error('å¯ç”¨ 2FA å¤±è´¥');
                                            }
                                        })
                                        .then(data => {
                                            const qrUrl = data.qr_url; // äºŒç»´ç  URL
                                            const secretKey = data.secret_key; // 2FA å¯†é’¥
                                            Swal.fire({
                                                title: 'æ‰«æäºŒç»´ç ä»¥å¯ç”¨ 2FA',
                                                html: `
										<p>è¯·ä½¿ç”¨ Google Authenticator æˆ–å…¶ä»– TOTP åº”ç”¨æ‰«æä»¥ä¸‹äºŒç»´ç ã€‚</p>
										<img src="${qrUrl}" style="width: 200px; height: 200px;" />
										<p>æˆ–è€…æ‰‹åŠ¨è¾“å…¥ä»¥ä¸‹å¯†é’¥ï¼š</p>
										<p style="font-family: Consolas; font-size: 16px; color: #333;">${secretKey}</p>
									`,
                                                confirmButtonText: 'å®Œæˆ',
                                                cancelButtonText: 'å–æ¶ˆ',
                                                showCancelButton: true,
                                            }).then((qrResult) => {
                                                if (qrResult.isConfirmed) {
                                                    verify2FAForEnable();
                                                } else {
                                                    Swal.fire({
                                                        title: 'æ“ä½œå–æ¶ˆ',
                                                        text: '2FA æœªå¯ç”¨',
                                                        icon: 'info',
                                                    });
                                                }
                                            });
                                        })
                                        .catch(error => {
                                            Swal.fire({
                                                title: 'é”™è¯¯',
                                                text: error.message,
                                                icon: 'error',
                                            });
                                        });
                                }
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'é”™è¯¯',
                            text: 'æ— æ³•è·å–ç”¨æˆ·çŠ¶æ€',
                            icon: 'error',
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'é”™è¯¯',
                        text: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
                        icon: 'error',
                    });
                });
        }
        function openLoginkeyRegistration() {
            fetch('/user_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: ``
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        if (data.is_2fa_enabled) {
                            // å¦‚æœå¯ç”¨äº† 2FAï¼Œå¼¹å‡º 2FA éªŒè¯çª—å£
                            Swal.fire({
                                title: 'æ³¨å†Œ Loginkey',
                                input: 'text',
                                inputLabel: 'è¯·è¾“å…¥ 2FA éªŒè¯ç ',
                                inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                                showCancelButton: true,
                                confirmButtonText: 'éªŒè¯å¹¶æ³¨å†Œ',
                                cancelButtonText: 'å–æ¶ˆ',
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    const code = result.value.trim();
                                    if (!code) {
                                        Swal.fire({
                                            title: 'é”™è¯¯',
                                            text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                                            icon: 'error',
                                        });
                                        return;
                                    }
                                    // æäº¤ 2FA éªŒè¯ç å’Œæ³¨å†Œè¯·æ±‚
                                    fetch('/register_loginkey', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                        },
                                        body: `code=${encodeURIComponent(code)}`
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.status === 'OK') {
                                                Swal.fire({
                                                    title: 'æ³¨å†ŒæˆåŠŸ',
                                                    text: `è¯·å¦¥å–„ä¿å­˜æ‚¨çš„ Loginkeyï¼š${data.loginkey}`,
                                                    icon: 'success',
                                                });
                                            } else {
                                                Swal.fire({
                                                    title: 'æ³¨å†Œå¤±è´¥',
                                                    text: data.message,
                                                    icon: 'error',
                                                });
                                            }
                                        });
                                }
                            });
                        } else {
                            // å¦‚æœæœªå¯ç”¨ 2FAï¼Œç›´æ¥æ³¨å†Œ Loginkey
                            fetch('/register_loginkey', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: ``
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'OK') {
                                        Swal.fire({
                                            title: 'æ³¨å†ŒæˆåŠŸ',
                                            text: `è¯·å¦¥å–„ä¿å­˜æ‚¨çš„ Loginkeyï¼š${data.loginkey}`,
                                            icon: 'success',
                                        });
                                    } else {
                                        Swal.fire({
                                            title: 'æ³¨å†Œå¤±è´¥',
                                            text: data.message,
                                            icon: 'error',
                                        });
                                    }
                                });
                        }
                    } else {
                        Swal.fire({
                            title: 'é”™è¯¯',
                            text: 'è¯·å…ˆç™»å½•åå†æ³¨å†Œ Loginkeyã€‚',
                            icon: 'error',
                        });
                    }
                });
        }
        function verify2FAForEnable() {
            Swal.fire({
                title: 'éªŒè¯ 2FA',
                input: 'text',
                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„ 2FA éªŒè¯ç ',
                inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                showCancelButton: true,
                confirmButtonText: 'éªŒè¯',
                cancelButtonText: 'å–æ¶ˆ',
            }).then((result) => {
                if (result.isConfirmed) {
                    const code = result.value.trim();
                    if (!code) {
                        Swal.fire({
                            title: 'é”™è¯¯',
                            text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                            icon: 'error',
                        });
                        return;
                    }

                    fetch('/verify_2fa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `code=${encodeURIComponent(code)}`,
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK') {
                                Swal.fire({
                                    title: 'éªŒè¯æˆåŠŸ',
                                    text: '2FA å·²æˆåŠŸå¯ç”¨',
                                    icon: 'success',
                                });
                            } else {
                                Swal.fire({
                                    title: 'éªŒè¯å¤±è´¥',
                                    text: data.message,
                                    icon: 'error',
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'é”™è¯¯',
                                text: 'éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜',
                                icon: 'error',
                            });
                        });
                } else {
                    Swal.fire({
                        title: 'æ“ä½œå–æ¶ˆ',
                        text: '2FA æœªå¯ç”¨',
                        icon: 'info',
                    });
                }
            });
        }

        function verify2FA() {
            Swal.fire({
                title: 'éªŒè¯ 2FA',
                input: 'text',
                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„ 2FA éªŒè¯ç ',
                inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                showCancelButton: true,
                confirmButtonText: 'éªŒè¯',
                cancelButtonText: 'å–æ¶ˆ',
            }).then((result) => {
                if (result.isConfirmed) {
                    const code = result.value.trim();
                    if (!code) {
                        Swal.fire({
                            title: 'é”™è¯¯',
                            text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                            icon: 'error',
                        });
                        return;
                    }

                    fetch('/verify_2fa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `code=${encodeURIComponent(code)}`,
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK') {
                                Swal.fire({
                                    title: 'éªŒè¯æˆåŠŸ',
                                    text: 'æ‚¨çš„ 2FA éªŒè¯å·²å®Œæˆ',
                                    icon: 'success',
                                });
                                return true;
                            } else {
                                Swal.fire({
                                    title: 'éªŒè¯å¤±è´¥',
                                    text: data.message,
                                    icon: 'error',
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'é”™è¯¯',
                                text: 'éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜',
                                icon: 'error',
                            });
                        });
                }
            });
        }
        function showNotification(message, status, willAutomaticallyRefresh) {
            if (status == 'ok') {
                let timerInterval;
                Swal.fire({
                    title: message,
                    icon: "success",
                    html: "ç³»ç»Ÿæ¶ˆæ¯ï¼Œå°†åœ¨ <b></b> æ¯«ç§’åè‡ªåŠ¨å…³é—­ã€‚",
                    timer: 1000,
                    timerProgressBar: true,
                    didOpen: () => {
                        const timer = Swal.getPopup().querySelector("b");
                        timerInterval = setInterval(() => {
                            timer.textContent = `${Swal.getTimerLeft()}`;
                        }, 10);
                    },
                    willClose: () => {
                        clearInterval(timerInterval);
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.timer) {
                        console.log("success");
                    }
                });
            }
            else {
                let timerInterval;
                Swal.fire({
                    title: message,
                    icon: "error",
                    html: "ç³»ç»Ÿæ¶ˆæ¯ï¼Œå°†åœ¨ <b></b> æ¯«ç§’åè‡ªåŠ¨å…³é—­ã€‚",
                    timer: 1000,
                    timerProgressBar: true,
                    didOpen: () => {
                        const timer = Swal.getPopup().querySelector("b");
                        timerInterval = setInterval(() => {
                            timer.textContent = `${Swal.getTimerLeft()}`;
                        }, 10);
                    },
                    willClose: () => {
                        clearInterval(timerInterval);
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.timer) {
                        console.log("success");
                    }
                });
            }
            if (willAutomaticallyRefresh == 1) location.reload();
        }

        function showRegisterForm() {
            fetch('/user_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: ``
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        showUserInformation(data.message);
                    } else {
                        document.getElementById('register-form').style.display = 'block';
                        document.getElementById('captcha-image-reg').src = '/captcha?' + String(Math.random(1, 1145141919810));
                    }
                });
        }

        function closeRegisterForm() {
            document.getElementById('register-form').style.display = 'none';
        }

        function showLoginForm() {
            fetch('/user_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: ``
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        document.getElementById('login-button').innerText = "ç™»å½•";
                        document.getElementById('register-button').innerText = "æ³¨å†Œ";
                        showNotification('æ‚¨å·²ä»ç”¨æˆ· ' + data.message + ' ç™»å‡ºã€‚', 'ok');
                        fetch('/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: ``
                        });
                        updateChatHistory();
                        document.getElementById('panel-button').style.display = 'none';
                    } else {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('captcha-image-log').src = '/captcha?' + String(Math.random(1, 1145141919810));
                        document.getElementById('panel-button').style.display = 'none';
                    }
                });
        }

        function closeLoginForm() {
            document.getElementById('login-form').style.display = 'none';
        }

        // è§£ææ¶ˆæ¯å†…å®¹ï¼Œå°† [xxxx] æ›¿æ¢ä¸º img æ ‡ç­¾
        function parseEmojiInMessage(msg) {
            return msg.replace(/\[([0-9a-fA-F\-]+)\]/g, function (match, code) {
                return `<img src="/static/emoji/${code}.png" alt="emoji" style="width:1.5em;height:1.5em;vertical-align:middle;" onerror="this.outerHTML='[${code}]'">`;
            });
        }

        function appendMessageToChatHistory(timestamp, username, message) {
            const chatHistoryDiv = document.getElementById('chat-history');
            const hr = document.createElement('hr');
            chatHistoryDiv.appendChild(hr);
            const p = document.createElement('p');
            // è§£æ emoji ä»£ç ä¸º img æ ‡ç­¾
            p.innerHTML = `ç”¨æˆ· ${username} è¯´é“ï¼š${parseEmojiInMessage(message)}`;
            let rawUsername = username.replace(/<[^>]+>/g, "").replace(/ç®¡ç†å‘˜/g, "").trim();
            if (
                currentUsername &&
                (currentUsername === rawUsername || currentUsernameIsAdmin())
            ) {
                const recallBtn = document.createElement('button');
                recallBtn.innerText = 'æ’¤å›';
                recallBtn.style = 'margin-left:8px;font-size:12px;padding:2px 8px;';
                recallBtn.onclick = function () {
                    Swal.fire({
                        title: 'ç¡®è®¤æ’¤å›ï¼Ÿ',
                        text: 'æ’¤å›åæ¶ˆæ¯å°†è¢«å½»åº•åˆ é™¤ï¼Œæ— æ³•æ¢å¤ï¼',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'æ’¤å›',
                        cancelButtonText: 'å–æ¶ˆ'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            fetch('/recall_message', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `timestamp=${encodeURIComponent(timestamp)}`
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'OK') {
                                        updateChatHistory();
                                    } else {
                                        Swal.fire('æ’¤å›å¤±è´¥', data.message, 'error');
                                    }
                                });
                        }
                    });
                };
                p.appendChild(recallBtn);
            }
            chatHistoryDiv.appendChild(p);
            const t = document.createElement('p');
            t.innerHTML = `${timestamp}`;
            t.style = `text-align:right;color:#999`;
            chatHistoryDiv.appendChild(t);
            /*Prism.highlightAll();*/
        }

        function currentUsernameIsAdmin() {
            if (!currentUsername) return false;
            return document.getElementById('panel-button').style.display !== 'none';
        }

        function updateChatHistoryWithNewMessage(data) {
            appendMessageToChatHistory(data.timestamp, data.username, data.message);
        }

        function updateChatHistory() {
            fetch('/get_chat_history')
                .then(response => response.json())
                .then(data => {
                    const chatHistoryDiv = document.getElementById('chat-history');
                    chatHistoryDiv.innerHTML = '';
                    data.reverse().forEach(entry => {
                        // è§£æ emoji ä»£ç 
                        appendMessageToChatHistory(entry.timestamp, entry.username, entry.message);
                    });
                    /*Prism.highlightAll();*/
                });
        }

        let currentUsername = null;
        fetch('user_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: ``
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'OK') {
                    currentUsername = data.message.replace(/<[^>]+>/g, "").replace(/ç®¡ç†å‘˜/g, "").trim();
                    document.getElementById('register-button').innerText = "æ‚¨å·²ç™»å½•";
                    document.getElementById('login-button').innerText = "ç™»å‡º";
                    showNotification('æ‚¨æ­£ä»¥ ' + data.message + ' çš„èº«ä»½èŠå¤©ã€‚', 'ok');
                    usingUsername = data.message;
                    updateChatHistory();
                } else {
                    showNotification('ç³»ç»Ÿæ¶ˆæ¯ï¼šç™»å½•åæ‰å¯å‘é€æ¶ˆæ¯ã€‚', 'fail');
                }
            });

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            let message = messageInput.value.trim();

            // å‘é€å‰æ— éœ€å¤„ç†ï¼Œç›´æ¥å‘é€ï¼Œåç«¯å­˜å‚¨ [xxxx] å½¢å¼
            if (message !== '') {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `message=${encodeURIComponent(message)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'OK') {
                            messageInput.value = '';
                        } else {
                            showNotification(data.message, 'fail');
                        }
                    });
            }
        }


        function sendCode() {
            const messageInput = document.getElementById('message-input-code');
            const message = messageInput.value.trim();

            if (message !== '') {
                fetch('/send_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `message=${encodeURIComponent(message)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'OK') {
                            messageInput.value = '';
                        } else {
                            showNotification(data.message, 'fail');
                        }
                    });
            }
        }

        function showEditForm(timestamp, message) {
            const editInput = document.getElementById(`edit-input-${timestamp}`);
            const saveButton = editInput.nextSibling;
            editInput.value = message;
            editInput.style.display = 'block';
            saveButton.style.display = 'block';
        }

        function saveEditedMessage(timestamp) {
            const editInput = document.getElementById(`edit-input-${timestamp}`);
            const newMessage = editInput.value.trim();

            if (newMessage !== '') {
                fetch('/edit_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `timestamp=${encodeURIComponent(timestamp)}&new_message=${encodeURIComponent(newMessage)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'OK') {
                            updateChatHistory();
                        } else {
                            showNotification(data.message, 'fail');
                        }
                    });
            }
        }


        document.getElementById('message-input').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        // åˆå§‹åŒ–åŠ è½½èŠå¤©è®°å½•
        updateChatHistory();

        function register() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirmPassword = document.getElementById('register-confirm-password').value.trim();
            const captcha = document.getElementById('register-captcha').value.trim();

            if (password !== confirmPassword) {
                showNotification('å¯†ç ä¸åŒ¹é…', 'fail');
                reloadCode(2);
                return;
            }

            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&captcha=${encodeURIComponent(captcha)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        showNotification('æ³¨å†ŒæˆåŠŸ', 'ok', 1);
                        closeRegisterForm();
                    } else {
                        reloadCode(2);
                        showNotification(data.message, 'fail');
                    }
                });
        }

        function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const captcha = document.getElementById('login-captcha').value.trim();
            fetch('/user_status_', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `username=${encodeURIComponent(username)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        if (data.is_2fa_enabled) {
                            Swal.fire({
                                title: 'éªŒè¯ 2FA',
                                input: 'text',
                                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„ 2FA éªŒè¯ç ',
                                inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                                showCancelButton: true,
                                confirmButtonText: 'éªŒè¯',
                                cancelButtonText: 'å–æ¶ˆ',
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    const code = result.value.trim();
                                    if (!code) {
                                        Swal.fire({
                                            title: 'é”™è¯¯',
                                            text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                                            icon: 'error',
                                        });
                                        return;
                                    }

                                    fetch('/login', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                        },
                                        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&captcha=${encodeURIComponent(captcha)}&code=${encodeURIComponent(code)}`
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.status === 'OK') {
                                                showNotification('ç™»å½•æˆåŠŸ', 'ok', 1);
                                                closeLoginForm();
                                            } else {
                                                showNotification(data.message, 'fail');
                                                reloadCode(1);
                                            }
                                        })
                                        .catch(error => {
                                            Swal.fire({
                                                title: 'é”™è¯¯',
                                                text: 'ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜',
                                                icon: 'error',
                                            });
                                        });
                                }
                            });
                        } else {
                            fetch('/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&captcha=${encodeURIComponent(captcha)}`
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'OK') {
                                        showNotification('ç™»å½•æˆåŠŸ', 'ok', 1);
                                        closeLoginForm();
                                    } else {
                                        showNotification(data.message, 'fail');
                                        reloadCode(1);
                                    }
                                });
                        }
                    }
                });
        }

        function verify2FAAfterLogin() {
            Swal.fire({
                title: 'éªŒè¯ 2FA',
                input: 'text',
                inputLabel: 'è¯·è¾“å…¥æ‚¨çš„ 2FA éªŒè¯ç ',
                inputPlaceholder: '6 ä½æ•°å­—éªŒè¯ç ',
                showCancelButton: true,
                confirmButtonText: 'éªŒè¯',
                cancelButtonText: 'å–æ¶ˆ',
            }).then((result) => {
                if (result.isConfirmed) {
                    const code = result.value.trim();
                    if (!code) {
                        Swal.fire({
                            title: 'é”™è¯¯',
                            text: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º',
                            icon: 'error',
                        });
                        return;
                    }

                    fetch('/verify_2fa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `code=${encodeURIComponent(code)}`,
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK') {
                                Swal.fire({
                                    title: 'éªŒè¯æˆåŠŸ',
                                    text: 'æ‚¨çš„ 2FA éªŒè¯å·²å®Œæˆ',
                                    icon: 'success',
                                }).then(() => {
                                    showNotification('ç™»å½•æˆåŠŸ', 'ok', 1);
                                    closeLoginForm();
                                });
                            } else {
                                Swal.fire({
                                    title: 'éªŒè¯å¤±è´¥',
                                    text: data.message,
                                    icon: 'error',
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'é”™è¯¯',
                                text: 'éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜',
                                icon: 'error',
                            });
                        });
                }
            });
        }

        function loginWithLoginkey() {
            Swal.fire({
                title: 'ä½¿ç”¨ Loginkey ç™»å½•',
                html: `
            <input type="text" id="swal-loginkey" class="swal2-input" placeholder="Loginkey">
        `,
                confirmButtonText: 'ç™»å½•',
                cancelButtonText: 'å–æ¶ˆ',
                showCancelButton: true,
                preConfirm: () => {
                    const loginkey = document.getElementById('swal-loginkey').value.trim();
                    if (!loginkey) {
                        Swal.showValidationMessage('Loginkey ä¸èƒ½ä¸ºç©º');
                        return false;
                    }
                    return loginkey;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const loginkey = result.value;
                    fetch('/login_with_loginkey', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `loginkey=${encodeURIComponent(loginkey)}`
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK') {
                                Swal.fire({
                                    title: 'ç™»å½•æˆåŠŸ',
                                    icon: 'success',
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    title: 'ç™»å½•å¤±è´¥',
                                    text: data.message,
                                    icon: 'error',
                                });
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'é”™è¯¯',
                                text: 'ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚',
                                icon: 'error',
                            });
                        });
                }
            });
        }
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                Swal.fire({
                    title: 'é”™è¯¯',
                    text: 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚',
                    icon: 'error',
                });
                return;
            }

            const recognition = new webkitSpeechRecognition();
            const selectedLanguage = document.getElementById('language-selector').value; // è·å–ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€
            recognition.lang = selectedLanguage; // è®¾ç½®è¯­è¨€
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            Swal.fire({
                title: 'æ­£åœ¨ç›‘å¬...',
                html: 'è¯·å¼€å§‹è¯´è¯...',
                allowOutsideClick: false,
                showCancelButton: true,
                cancelButtonText: 'å–æ¶ˆ',
                didOpen: () => {
                    recognition.start();
                },
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value += transcript;
                Swal.close();
            };

            recognition.onerror = (event) => {
                Swal.fire({
                    title: 'é”™è¯¯',
                    text: 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚',
                    icon: 'error',
                });
            };
        }
        function openEmojiPicker() {
            const emojis = [
                'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤”',
                'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“',
                'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦'
            ];

            let emojiHtml = '';
            emojis.forEach(emoji => {
                const code = Array.from(emoji).map(c => c.codePointAt(0).toString(16)).join('-');
                emojiHtml += `<button class="emoji-button" style="justify-content: center;width: 9%;margin: 0 auto;padding: 10px;" onclick="addEmojiToInputImg('${code}')"><img src="/static/emoji/${code}.png" alt="${emoji}" style="width:1.5em;height:1.5em;vertical-align:middle;"></button>`;
            });

            Swal.fire({
                title: 'é€‰æ‹©ä¸€ä¸ª Emoji',
                html: `<div style="display: flex; flex-wrap: wrap; gap: 5px;">${emojiHtml}</div>`,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'å…³é—­',
            });
        }

        // æ’å…¥ emoji ä»£ç ï¼ˆä¸å†æ’å…¥ img æ ‡ç­¾ï¼Œæ’å…¥ [code] å½¢å¼ï¼‰
        function addEmojiToInputImg(code) {
            const input = document.getElementById('message-input');
            input.value += `[${code}]`;
            Swal.close();
        }
        function openEmojiPickerCode() {
            const emojis = [
                'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤”',
                'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“',
                'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦'
            ];

            let emojiHtml = '';
            emojis.forEach(emoji => {
                emojiHtml += `<button class="emoji-button" style="justify-content: center;width: 9%;margin: 0 auto;padding: 10px;" onclick="addEmojiToInput('${emoji}')">${emoji}</button>`;
            });

            Swal.fire({
                title: 'é€‰æ‹©ä¸€ä¸ª Emoji',
                html: `<div style="display: flex; flex-wrap: wrap; gap: 8.4px;">${emojiHtml}</div>`,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'å…³é—­',
            });
        }

        function addEmojiToCode(emoji) {
            const input = document.getElementById('message-input-code');
            input.value += emoji;
            Swal.close(); // å…³é—­ Emoji é€‰æ‹©å™¨
        }

        // è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼ˆä¸å«è‡ªå·±ï¼‰
        function fetchAllUsers(callback) {
            fetch('/get_all_users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: ``
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        callback(data.users || []);
                    } else {
                        callback([]);
                    }
                });
        }

        // ç§èŠé¢æ¿ï¼šé€‰æ‹©ç”¨æˆ·ã€æ˜¾ç¤ºå†å²ã€å‘é€æ¶ˆæ¯
        function openPrivateChatPanel() {
            location.href = '/chat'
        }

        function showPrivatePanelV2(contacts, allUsers, myName) {
            let selectedUser = contacts.length > 0 ? contacts[0] : '';
            let contactsHtml = contacts.map(u =>
                `<div class="private-contact-item" data-user="${u}" style="padding:10px;cursor:pointer;border-bottom:1px solid #eee;font-size:16px;">${u}</div>`
            ).join('') || '<div style="color:#aaa;padding:12px;">æš‚æ— ç§èŠ</div>';
            let addBtnHtml = `<button id="add-private-user-btn" style="width:96%;margin:8px 2% 8px 2%;">â• æ·»åŠ ç”¨æˆ·</button>`;
            Swal.fire({
                title: 'ç§èŠé¢æ¿',
                html: `
                <div style="display:flex;min-width:320px;max-width:98vw;height:350px;">
                    <div style="width:120px;display:flex;flex-direction:column;border-right:1px solid #eee;height:100%;">
                        ${addBtnHtml}
                        <div id="private-contacts-list" style="flex:1;overflow:auto;">${contactsHtml}</div>
                    </div>
                    <div style="flex:1;display:flex;flex-direction:column;height:100%;padding-left:8px;">
                        <div id="private-chat-title" style="font-weight:bold;margin-bottom:8px;font-size:16px;">${selectedUser ? 'ä¸ ' + selectedUser + ' çš„ç§èŠ' : 'è¯·é€‰æ‹©ç”¨æˆ·'}</div>
                        <div id="private-history" style="flex:1;overflow:auto;border:1px solid #eee;padding:4px 8px;margin-bottom:8px;background:#fafbfc;height:120px;font-size:14px;"></div>
                        <div style="display:flex;gap:6px;">
                            <input id="private-message" class="swal2-input" placeholder="è¾“å…¥ç§èŠå†…å®¹" style="flex:1;margin-bottom:0;font-size:15px;">
                            <button id="private-send-btn" style="width:60px;">å‘é€</button>
                        </div>
                    </div>
                </div>
                `,
                showCancelButton: true,
                showConfirmButton: false,
                cancelButtonText: 'å…³é—­',
                didOpen: () => {
                    let currentUser = selectedUser;
                    const contactsList = document.getElementById('private-contacts-list');
                    const chatTitle = document.getElementById('private-chat-title');
                    const historyDiv = document.getElementById('private-history');
                    const sendBtn = document.getElementById('private-send-btn');
                    const msgInput = document.getElementById('private-message');
                    if (currentUser) loadPrivateHistoryV2(currentUser, historyDiv, myName);

                    contactsList.querySelectorAll('.private-contact-item').forEach(item => {
                        item.onclick = function () {
                            currentUser = this.getAttribute('data-user');
                            chatTitle.innerText = 'ä¸ ' + currentUser + ' çš„ç§èŠ';
                            loadPrivateHistoryV2(currentUser, historyDiv, myName);
                        };
                    });

                    sendBtn.onclick = function () {
                        if (!currentUser) {
                            Swal.showValidationMessage('è¯·é€‰æ‹©ç”¨æˆ·');
                            return;
                        }
                        let msg = msgInput.value.trim();
                        if (!msg) {
                            Swal.showValidationMessage('è¯·è¾“å…¥å†…å®¹');
                            return;
                        }
                        sendPrivateMessageWithReloadV2(currentUser, msg, historyDiv, myName, () => {
                            msgInput.value = '';
                        });
                    };

                    msgInput.addEventListener('keyup', function (e) {
                        if (e.key === 'Enter') sendBtn.onclick();
                    });

                    document.getElementById('add-private-user-btn').onclick = function () {
                        Swal.fire({
                            title: 'æ·»åŠ ç§èŠç”¨æˆ·',
                            input: 'select',
                            inputOptions: allUsers.filter(u => u !== myName && !contacts.includes(u)).reduce((obj, u) => { obj[u] = u; return obj; }, {}),
                            inputPlaceholder: 'é€‰æ‹©ç”¨æˆ·',
                            showCancelButton: true,
                            confirmButtonText: 'æ·»åŠ ',
                            cancelButtonText: 'å–æ¶ˆ'
                        }).then(res => {
                            if (res.isConfirmed && res.value) {
                                let newUser = res.value;
                                if (!contacts.includes(newUser)) contacts.push(newUser);
                                Swal.close();
                                setTimeout(() => showPrivatePanelV2(contacts, allUsers, myName), 100);
                            }
                        });
                    };
                }
            });
        }

        function loadPrivateHistoryV2(toUser, historyDiv, myName) {
            historyDiv.innerHTML = 'åŠ è½½ä¸­...';
            fetch('/get_private_history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `with_user=${encodeURIComponent(toUser)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        fetch('/mark_private_read', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `with_user=${encodeURIComponent(toUser)}`
                        });
                        let html = '';
                        data.messages.forEach(m => {
                            let status = '';
                            if (m.from === myName) {
                                status = m.read ? '<span style="color:green;font-size:12px;">[å·²è¯»]</span>' : '<span style="color:#aaa;font-size:12px;">[æœªè¯»]</span>';
                            }
                            html += `<div style="margin-bottom:8px;"><b>${m.from}</b> â¡ <b>${m.to}</b>ï¼š${m.message} ${status}<br><span style="color:#888;font-size:12px">${m.timestamp}</span></div>`;
                        });
                        historyDiv.innerHTML = html || 'æš‚æ— æ¶ˆæ¯';
                    } else {
                        historyDiv.innerHTML = 'è·å–å¤±è´¥ï¼š' + data.message;
                    }
                });
        }

        function sendPrivateMessageWithReloadV2(toUser, msg, historyDiv, myName, cb) {
            fetch('/send_private_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `to_user=${encodeURIComponent(toUser)}&message=${encodeURIComponent(msg)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        loadPrivateHistoryV2(toUser, historyDiv, myName);
                        if (cb) cb();
                    } else {
                        Swal.showValidationMessage('å‘é€å¤±è´¥ï¼š' + data.message);
                    }
                });
        }

        // SocketIO å®æ—¶æ¥æ”¶ç§èŠæ¶ˆæ¯ï¼ˆå¦‚æœ‰ socket æ”¯æŒå¯åŠ ï¼‰
        if (window.socket) {
            socket.on('private_message', function (data) {
                Swal.fire({
                    title: 'æ”¶åˆ°ç§èŠæ¶ˆæ¯',
                    html: `<b>${data.from}</b> â¡ <b>${data.to}</b>ï¼š${data.message}<br><span style="color:#888;font-size:12px">${data.timestamp}</span>`,
                    icon: 'info'
                });
            });
        }
    </script>
    <script src="{{ url_for('static', filename='sweetalert2.all.min.js') }}"></script>
    <script src="{{ url_for('static', filename='prism.js') }}"></script>

    <br><br>
    <footer>
        <center>
            <div style="display: inline-flex; align-items: center; font-family: Consolas; color: #000;">
                Using <a href="https://github.com/nr0728/Chat-Room" style="text-decoration: none; margin: 0 5px;">
                    <font color="#8CC269">Chat-Room</font>
                </a>.
                Latest Release: <img src="https://img.shields.io/github/v/release/nr0728/Chat-Room?color=%23FFFF00"
                    style="height: 20px; vertical-align: middle;" />
            </div>
        </center>
    </footer>

</body>

</html>